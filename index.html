<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Meu Cassino — Robô Assistente</title>

<!-- Three.js CDN para 3D -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r153/three.min.js" integrity="" crossorigin="anonymous"></script>

<style>
  :root{
    --bg:#071428; --card:#0b1225; --muted:#9fb0c8; --accent:#7c3aed;
    --banca:#e74c3c; --player:#3498db; --empate:#f2c94c; --text:#eaf2ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, Arial, Helvetica, sans-serif;background:linear-gradient(180deg,var(--bg),#041025);color:var(--text);-webkit-font-smoothing:antialiased}
  .center{display:flex;align-items:center;justify-content:center;height:100vh}
  .panel{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.6);width:95%;max-width:980px}
  .row{display:flex;gap:8px;align-items:center}
  input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
  button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:white;font-weight:700;cursor:pointer}
  .muted{color:var(--muted);font-size:0.9rem}
  /* layout */
  #app{padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .profile{display:flex;gap:12px;align-items:center}
  .avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(90deg,#3b2a77,#6b50e8);display:flex;align-items:center;justify-content:center;font-weight:800}
  main{display:grid;grid-template-columns:1fr 420px;gap:16px}
  .card{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px solid rgba(255,255,255,0.03)}
  #sceneContainer{height:320px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .sinal{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;font-weight:800;justify-content:center}
  .sinal .dot{width:18px;height:18px;border-radius:6px}
  .history{max-height:320px;overflow:auto;margin-top:8px;border-radius:8px;padding:8px;background:rgba(255,255,255,0.01)}
  .hist-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03)}
  .small{font-size:0.9rem;color:var(--muted)}
  .hidden{display:none}
  footer{margin-top:12px;text-align:center;color:var(--muted);font-size:0.85rem}
  @media(max-width:920px){main{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- Simple hash routing: #login or #room -->
<div id="root"></div>

<script>
// ---------- Utilidades ----------
function $(id){return document.getElementById(id)}
function setPage(html){document.getElementById('root').innerHTML = html; initPage();}

// ---------- PRNG seeded ----------
function mulberry32(a){ return function(){ a |= 0; a = a + 0x6D2B79F5 | 0; var t = Math.imul(a ^ a >>> 15, 1 | a); t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t; return ((t ^ t >>> 14) >>> 0) / 4294967296; }; }

// ---------- Color detection util (RGB->HSV) ----------
function rgbToHsv(r,g,b){
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h=0, s=0, v=max;
  const d=max-min; s = max===0?0:d/max;
  if(max===min) h=0; else {
    switch(max){
      case r: h=(g-b)/d+(g<b?6:0); break;
      case g: h=(b-r)/d+2; break;
      case b: h=(r-g)/d+4; break;
    }
    h/=6;
  }
  return {h:Math.round(h*360), s:Math.round(s*100), v:Math.round(v*100)};
}

// ---------- Simple outcome map ----------
function mapHsvOutcome(hsv){
  const h=hsv.h, s=hsv.s, v=hsv.v;
  if(s<12 && v>92) return {o:null, reason:'claro'};
  if((h>=340 && h<=360) || (h>=0 && h<=25) || (h>=320 && h<=340)) return {o:'B', label:'Banca', color:'#e74c3c'};
  if(h>=195 && h<=260) return {o:'P', label:'Player', color:'#3498db'}; // P = player
  if(h>=40 && h<=90) return {o:'T', label:'Empate', color:'#f2c94c'}; // T = tie
  return {o:null, reason:'indef'};
}

// ---------- App HTML (login) ----------
const loginHTML = `
<div class="center" style="padding:18px">
  <div class="panel" style="max-width:540px">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      <div style="font-size:26px;font-weight:800;background:linear-gradient(90deg,#3b2a77,#6b50e8);-webkit-background-clip:text;color:transparent">Meu Cassino</div>
      <div class="muted small">Robô Assistente</div>
    </div>
    <div class="row" style="margin-top:12px">
      <input id="nameInput" type="text" placeholder="Seu nome (ex: Graciano)">
      <button id="enterBtn">Entrar</button>
    </div>
    <div class="small" style="margin-top:10px">Cria uma sessão com teu nome. Todos que entrarem podem testar no mesmo link.</div>
  </div>
</div>
`;

// ---------- Room HTML template ----------
function roomHTML(name){
return `
<div id="app" style="padding:18px">
  <div class="panel" style="padding:14px">
    <header>
      <div class="profile">
        <div class="avatar">${name.slice(0,1).toUpperCase()}</div>
        <div>
          <div style="font-weight:800">${name}</div>
          <div class="small">Robô: automático · 1 screenshot → previsão</div>
        </div>
      </div>
      <div>
        <button id="logoutBtn" style="background:#ff6060">Sair</button>
      </div>
    </header>

    <main>
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Cenário 3D</div>
              <div class="small">Mesa rotativa — visual ao vivo</div>
            </div>
            <div class="small">Intervalo: <span id="intervalLabel">6s</span></div>
          </div>
          <div id="sceneContainer" style="margin-top:12px"></div>

          <div class="controls" style="margin-top:12px">
            <label class="small">Algoritmo:</label>
            <select id="algoSelect" class="small" style="padding:8px;border-radius:8px;background:transparent;color:var(--text)">
              <option value="mul">Mulberry32</option>
              <option value="math">Math.random</option>
            </select>
            <label class="small">Seed:</label>
            <input id="seedInput" type="text" placeholder="deixa vazio para aleatório" style="width:120px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">
            <button id="initBtn">Iniciar Sim</button>
            <button id="autoBtn" class="ghost" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)">Auto (Desligado)</button>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <input id="imgFile" type="file" accept="image/*" style="color:var(--muted)">
            <button id="analyzeBtn">Analisar (1 imagem)</button>
            <button id="useAsRoundBtn">Usar como rodada</button>
            <button id="genPredictBtn">Gerar previsão 2–3</button>
          </div>
          <img id="previewImg" style="margin-top:8px;max-width:220px;border-radius:8px;display:block"/>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Sinal</strong></div>
            <div class="small">Direto — sem explicação</div>
          </div>
          <div id="signalBox" style="margin-top:12px">
            <div class="sinal" id="mainSignal" style="background:rgba(255,255,255,0.03)">
              <div class="dot" id="signalDot" style="background:#888"></div>
              <div id="signalText" style="font-weight:900">—</div>
            </div>
          </div>

          <div style="margin-top:12px" class="small">Previsões (próximas 2–3 rodadas)</div>
          <div id="predList" style="display:flex;gap:8px;margin-top:8px"></div>
        </div>

      </div>

      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Histórico</strong></div>
            <div class="small">Últimas 50</div>
          </div>
          <div class="history" id="historyBox"></div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="exportBtn" class="ghost" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)">Exportar</button>
            <button id="clearBtn" class="ghost" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)">Limpar</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="small">Sessão e estatísticas</div>
          <div style="margin-top:8px" class="small">Rodadas: <span id="statRounds">0</span> • Coincidências: <span id="statMatch">0</span></div>
          <div style="margin-top:8px" class="small">Tempo local: <span id="localTime">--:--:--</span></div>
        </div>

      </div>
    </main>

    <footer class="small">© Meu Cassino — uso apenas para treino</footer>
  </div>
</div>
`}

// ---------- Router: show login or room ----------
function goToLogin(){ document.getElementById('root').innerHTML = loginHTML; initPage(); }
function goToRoom(name){ document.getElementById('root').innerHTML = roomHTML(name); initPage(); }

// ---------- Init page wiring ----------
function initPage(){
  // login page wiring
  const enterBtn = document.querySelector('#enterBtn');
  if(enterBtn){
    enterBtn.addEventListener('click', ()=>{
      const name = document.getElementById('nameInput').value.trim() || 'Player';
      localStorage.setItem('mc_name', name);
      location.hash = '#room';
      render();
    });
    return;
  }

  // room page wiring
  const logoutBtn = document.getElementById('logoutBtn');
  if(logoutBtn){
    logoutBtn.addEventListener('click', ()=>{
      localStorage.removeItem('mc_name');
      location.hash = '';
      render();
    });
  }

  // initialize scene (three.js)
  initScene();

  // session name
  const name = localStorage.getItem('mc_name') || 'Player';
  // UI refs
  const initBtn = document.getElementById('initBtn');
  const autoBtn = document.getElementById('autoBtn');
  const imgFile = document.getElementById('imgFile');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const useAsRoundBtn = document.getElementById('useAsRoundBtn');
  const genPredictBtn = document.getElementById('genPredictBtn');
  const algoSelect = document.getElementById('algoSelect');
  const seedInput = document.getElementById('seedInput');
  const previewImg = document.getElementById('previewImg');
  const exportBtn = document.getElementById('exportBtn');
  const clearBtn = document.getElementById('clearBtn');

  // state
  let prngA = Math.random;
  let rounds = []; // 'B','P','T' newest first
  let matches = 0;
  let roundsCount = 0;
  let autoOn = false;
  let autoTimer = null;
  let currentPrediction = [];

  // helpers
  function now(){ document.getElementById('localTime').innerText = new Date().toLocaleTimeString(); }
  setInterval(now,1000); now();

  function initGenerators(){
    const algo = algoSelect.value;
    const seed = parseInt(seedInput.value) || Date.now() & 0xffffffff;
    if(algo === 'mul'){
      prngA = mulberry32(seed);
    } else prngA = Math.random;
    appendHistory('Sistema', `Gerador iniciado (algo=${algo}, seed=${seed})`);
  }

  function appendHistory(who, text){
    const box = document.getElementById('historyBox');
    const el = document.createElement('div');
    el.className = 'hist-item';
    el.innerHTML = `<div style="font-weight:700">${who}</div><div class="small">${text}</div>`;
    box.prepend(el);
  }

  function renderRounds(){
    const box = document.getElementById('historyBox');
    // also render rounds top of history (compact)
    let listHtml = '';
    rounds.forEach((r,i)=>{
      const label = r==='B' ? 'Banca' : r==='P' ? 'Jogador' : 'Empate';
      listHtml += `<div class="hist-item"><div>${label}</div><div class="small">${new Date().toLocaleTimeString()}</div></div>`;
    });
    // replace first part of history (not necessary)
  }

  function detectOutcomeFromImageFile(file){
    return new Promise((res,rej)=>{
      if(!file) return rej('no file');
      const img = new Image();
      const url = URL.createObjectURL(file);
      img.onload = ()=>{
        // draw small canvas sample
        const c = document.createElement('canvas');
        const max = 600;
        let w = img.width, h = img.height, scale = Math.min(1, max/Math.max(w,h));
        w = Math.round(w*scale); h = Math.round(h*scale);
        c.width = w; c.height = h;
        const ctx = c.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        // central crop
        const cx = Math.floor(w*0.5), cy = Math.floor(h*0.5);
        const rw = Math.max(10, Math.floor(w*0.3)), rh = Math.max(10, Math.floor(h*0.3));
        const sx = Math.max(0, cx-Math.floor(rw/2)), sy = Math.max(0, cy-Math.floor(rh/2));
        const data = ctx.getImageData(sx,sy,rw,rh).data;
        let rSum=0,gSum=0,bSum=0,count=0;
        const step = 4 * Math.max(1, Math.floor((rw*rh)/3000));
        for(let i=0;i<data.length;i+=step){
          rSum += data[i]; gSum += data[i+1]; bSum += data[i+2]; count++;
        }
        const rAvg = Math.round(rSum/count), gAvg=Math.round(gSum/count), bAvg=Math.round(bSum/count);
        const hsv = rgbToHsv(rAvg,gAvg,bAvg);
        const mapped = mapHsvOutcome(hsv);
        res({r:rAvg,g:gAvg,b:bAvg,hsv, mapped});
        URL.revokeObjectURL(url);
      };
      img.onerror = (e)=>{ URL.revokeObjectURL(url); rej(e); };
      img.src = url;
      previewImg.src = url;
    });
  }

  function pushRound(code){
    rounds.unshift(code);
    if(rounds.length>50) rounds.pop();
    roundsCount++;
    document.getElementById('statRounds').innerText = roundsCount;
    // render history summary
    const hb = document.getElementById('historyBox');
    const name = code==='B'?'Banca':code==='P'?'Jogador':'Empate';
    const el = document.createElement('div'); el.className='hist-item';
    el.innerHTML = `<div style="font-weight:800">${name}</div><div class="small">${new Date().toLocaleTimeString()}</div>`;
    hb.prepend(el);
  }

  function generatePredictions(fromLastCode){
    // generate 2-3 predictions using simple hybrid: if last is repeated, small contrarian, else follow slight momentum
    const preds = [];
    const rng = prngA;
    const last = fromLastCode || rounds[0] || null;
    for(let i=0;i<3;i++){
      let p;
      const r = rng();
      if(last){
        // if last was B (banca), slight chance to continue, else probabilistic
        if(last==='B'){ p = r < 0.52 ? 'B' : (r < 0.86 ? 'P' : 'T'); }
        else if(last==='P'){ p = r < 0.52 ? 'P' : (r < 0.86 ? 'B' : 'T'); }
        else { p = r < 0.60 ? 'B' : (r < 0.92 ? 'P' : 'T'); }
      } else {
        p = r < 0.48 ? 'B' : (r < 0.96 ? 'P' : 'T');
      }
      preds.push(p);
    }
    currentPrediction = preds;
    renderPredictions(preds);
    // set main signal to first
    setMainSignal(preds[0]);
  }

  function setMainSignal(code){
    const text = code==='B'?'Banca':code==='P'?'Jogador':'Empate';
    const dot = document.getElementById('signalDot');
    const st = document.getElementById('signalText');
    if(code==='B'){ dot.style.background = 'var(--banca)'; st.innerText = text; }
    if(code==='P'){ dot.style.background = 'var(--player)'; st.innerText = text; }
    if(code==='T'){ dot.style.background = 'var(--empate)'; st.innerText = text; }
  }

  function renderPredictions(preds){
    const box = document.getElementById('predList');
    box.innerHTML = '';
    preds.forEach((p,i)=>{
      const el = document.createElement('div');
      const label = p==='B'?'Banca':p==='P'?'Jogador':'Empate';
      const color = p==='B'?'var(--banca)':p==='P'?'var(--player)':'var(--empate)';
      el.style.padding='8px 12px';
      el.style.borderRadius='10px';
      el.style.background = color;
      el.style.color = '#000';
      el.style.fontWeight = '800';
      el.innerText = label;
      box.appendChild(el);
    });
  }

  function exportLog(){
    const text = rounds.map((r,i)=>`${i+1}|${r}`).join('\n');
    const blob = new Blob([text],{type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='log.txt'; a.click(); URL.revokeObjectURL(url);
  }

  // events
  initBtn.addEventListener('click', ()=>{ initGenerators(); });

  analyzeBtn.addEventListener('click', async ()=>{
    const f = imgFile.files[0];
    if(!f) return alert('Carrega uma imagem primeiro');
    try{
      const res = await detectOutcomeFromImageFile(f);
      if(res.mapped.o){
        appendHistory('Detector', `${res.mapped.label} (h=${res.hsv.h})`);
        // automatic push: show brief badge, but do not push to rounds until user confirms (useAsRound)
        setMainSignal(res.mapped.o);
      } else {
        appendHistory('Detector', `Indefinido (${res.mapped.reason})`);
        alert('Resultado indefinido — tenta cortar melhor a área antes de carregar.');
      }
    } catch(e){
      alert('Erro ao analisar: ' + e);
    }
  });

  useAsRoundBtn.addEventListener('click', ()=>{
    // use current signalText to push
    const st = document.getElementById('signalText').innerText;
    const map = {'Banca':'B','Jogador':'P','Empate':'T'};
    const code = map[st];
    if(!code) return alert('Nenhum resultado detectado para usar.');
    pushRound(code);
    appendHistory('Sistema', `Rodada adicionada: ${st}`);
    // after pushing, auto generate predictions
    generatePredictions(code);
  });

  genPredictBtn.addEventListener('click', ()=>{
    generatePredictions(rounds[0] || null);
    appendHistory('Sistema','Previsões geradas');
  });

  document.getElementById('autoBtn').addEventListener('click', ()=>{
    autoOn = !autoOn;
    if(autoOn){
      autoBtn.innerText = 'Auto (Ligado)';
      const interval = parseFloat(prompt('Intervalo em segundos','6')) || 6;
      document.getElementById('intervalLabel').innerText = `${interval}s`;
      autoTimer = setInterval(()=>{
        // simulate a round automatically (use prng)
        const r = prngA();
        const code = r < 0.48 ? 'B' : (r < 0.96 ? 'P' : 'T');
        pushRound(code);
        appendHistory('Auto', `Rodada simulada: ${code==='B'?'Banca':code==='P'?'Jogador':'Empate'}`);
        generatePredictions(code);
      }, Math.max(1,interval)*1000);
    } else {
      autoBtn.innerText = 'Auto (Desligado)';
      clearInterval(autoTimer);
    }
  });

  clearBtn.addEventListener('click', ()=>{
    if(!confirm('Limpar histórico?')) return;
    rounds = []; roundsCount = 0; matches = 0;
    document.getElementById('historyBox').innerHTML = '';
    document.getElementById('statRounds').innerText = '0';
    document.getElementById('statMatch').innerText = '0';
  });

  exportBtn.addEventListener('click', exportLog);

  // quick init
  initGenerators();
}

// ---------- 3D scene using three.js ----------
let scene, camera, renderer, tableMesh, animId;
function initScene(){
  const container = document.getElementById('sceneContainer');
  if(!container) return;
  const W = container.clientWidth, H = container.clientHeight || 320;
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(50, W/H, 0.1, 2000);
  camera.position.set(0, 120, 220);
  renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setSize(W, H);
  container.appendChild(renderer.domElement);

  // light
  const dir = new THREE.DirectionalLight(0xffffff, 0.9);
  dir.position.set(0,200,100);
  scene.add(dir);
  scene.add(new THREE.AmbientLight(0xffffff, 0.25));

  // table (simple cylinder + texture)
  const geo = new THREE.CylinderGeometry(120,120,12,64);
  const matTop = new THREE.MeshStandardMaterial({color:0x052f3b, metalness:0.2, roughness:0.6});
  tableMesh = new THREE.Mesh(geo, matTop);
  tableMesh.rotation.x = Math.PI/2;
  scene.add(tableMesh);

  // center chip (visual)
  const chipGeo = new THREE.TorusGeometry(40,6,16,100);
  const chipMat = new THREE.MeshStandardMaterial({color:0x8f7ae6, metalness:0.6, roughness:0.3});
  const chip = new THREE.Mesh(chipGeo, chipMat);
  chip.rotation.x = Math.PI/2;
  chip.position.y = 8;
  scene.add(chip);

  // animate
  function animate(){
    animId = requestAnimationFrame(animate);
    tableMesh.rotation.z += 0.002;
    chip.rotation.z -= 0.01;
    renderer.render(scene, camera);
  }
  animate();
  window.addEventListener('resize', ()=>{ if(renderer){ renderer.setSize(container.clientWidth, container.clientHeight||320); camera.aspect = container.clientWidth/(container.clientHeight||320); camera.updateProjectionMatrix(); }});
}

// ---------- initial render ----------
function render(){
  const name = localStorage.getItem('mc_name');
  if(!name) setPage(loginHTML);
  else setPage(roomHTML(name));
}
render();

// ensure hash routing simple
window.addEventListener('hashchange', render);
</script>
</body>
</html>
